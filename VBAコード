Option Explicit

' ---------------------------------------------------------------------------------------
' Procedure : FormatAndCalculateAllSheets
' Purpose   : 全シートを対象に、ヘッダー位置（「単位」）を特定し、
'             隣接する「単価」項目の有無に応じて書式設定と数式入力を行う。
' ---------------------------------------------------------------------------------------
Sub FormatAndCalculateAllSheets()
    Dim ws As Worksheet
    Dim headerRow As Long
    Dim lastRow As Long
    Dim i As Long
    Dim matchedColumn As String ' "C" または "D"
    Dim checkVal As String
    Dim dataStartRow As Long
    
    ' 画面更新と自動計算を停止して処理速度を向上させる
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    ' 1. ループ処理: ブック内の全てのシートを巡回
    For Each ws In ThisWorkbook.Worksheets
        
        ' 変数の初期化
        headerRow = 0
        matchedColumn = ""
        
        ' 2. ヘッダー行の特定: 1行目から5行目を探索
        For i = 1 To 5
            ' C列に「単位」が含まれるか確認
            If InStr(ws.Cells(i, "C").Value, "単位") > 0 Then
                headerRow = i
                matchedColumn = "C"
                Exit For ' 見つかったらループを抜ける
            ' D列に「単位」が含まれるか確認
            ElseIf InStr(ws.Cells(i, "D").Value, "単位") > 0 Then
                headerRow = i
                matchedColumn = "D"
                Exit For ' 見つかったらループを抜ける
            End If
        Next i
        
        ' ヘッダーが見つかった場合のみ処理を続行
        If headerRow > 0 Then
            
            ' データの最終行を取得（C列を基準とする）
            lastRow = ws.Cells(ws.Rows.Count, "C").End(xlUp).Row
            dataStartRow = headerRow + 1
            
            ' データ行が存在する場合のみ実行（ヘッダーのみのシートを除外）
            If lastRow >= dataStartRow Then
                
                ' 3. 条件分岐処理
                If matchedColumn = "C" Then
                    ' 【パターンA】 C列に「単位」がある場合
                    
                    ' ヘッダー行のD列の値を取得し、スペースを除去して「単価」と比較
                    checkVal = ws.Cells(headerRow, "D").Value
                    checkVal = Replace(checkVal, " ", "")  ' 半角スペース除去
                    checkVal = Replace(checkVal, "　", "") ' 全角スペース除去
                    
                    ' D列が「単価」ではない場合
                    If checkVal <> "単価" Then
                        ' E列の書式設定（右揃え、下揃え、インデント0、折り返し解除）
                        With ws.Range(ws.Cells(dataStartRow, "E"), ws.Cells(lastRow, "E"))
                            .HorizontalAlignment = xlRight
                            .VerticalAlignment = xlBottom
                            .WrapText = False
                            .IndentLevel = 0
                        End With
                    End If
                    
                ElseIf matchedColumn = "D" Then
                    ' 【パターンB】 D列に「単位」がある場合
                    
                    ' ヘッダー行のE列の値を取得し、スペースを除去して「単価」と比較
                    checkVal = ws.Cells(headerRow, "E").Value
                    checkVal = Replace(checkVal, " ", "")
                    checkVal = Replace(checkVal, "　", "")
                    
                    If checkVal = "単価" Then
                        ' --- 条件: E列が「単価」の場合 ---
                        
                        ' C列、E列、F列の書式設定（右揃え、下揃え、インデント0、折り返し解除）
                        ' Unionを使用して複数の範囲をまとめて設定
                        With Union(ws.Range(ws.Cells(dataStartRow, "C"), ws.Cells(lastRow, "C")), _
                                   ws.Range(ws.Cells(dataStartRow, "E"), ws.Cells(lastRow, "E")), _
                                   ws.Range(ws.Cells(dataStartRow, "F"), ws.Cells(lastRow, "F")))
                            .HorizontalAlignment = xlRight
                            .VerticalAlignment = xlBottom
                            .WrapText = False
                            .IndentLevel = 0
                        End With
                        
                        ' F列に数式を入力 (=C列 * E列)
                        ' まず先頭セルに数式を入力
                        ws.Cells(dataStartRow, "F").Formula = "=C" & dataStartRow & "*E" & dataStartRow
                        
                        ' 最終行までオートフィル（データ行が複数ある場合のみ）
                        If lastRow > dataStartRow Then
                            ws.Cells(dataStartRow, "F").AutoFill _
                                Destination:=ws.Range(ws.Cells(dataStartRow, "F"), ws.Cells(lastRow, "F"))
                        End If
                        
                    Else
                        ' --- 条件: E列が「単価」ではない場合 ---
                        
                        ' E列の書式設定（右揃え、下揃え、インデント0、折り返し解除）
                        With ws.Range(ws.Cells(dataStartRow, "E"), ws.Cells(lastRow, "E"))
                            .HorizontalAlignment = xlRight
                            .VerticalAlignment = xlBottom
                            .WrapText = False
                            .IndentLevel = 0
                        End With
                    End If
                End If
            End If
        End If
    Next ws
    
    ' 設定を元に戻す
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic

    MsgBox "全シートの処理が完了しました。", vbInformation, "完了"

End Sub

