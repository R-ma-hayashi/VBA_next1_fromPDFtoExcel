Option Explicit

' ---------------------------------------------------------------------------------------
' Procedure : FormatAndCalculateAllFilesInFolder
' Purpose   : 同一フォルダ内の全Excelブックを開き、ProcessWorkbookを実行するメイン処理
' ---------------------------------------------------------------------------------------
Sub FormatAndCalculateAllFilesInFolder()
    Dim folderPath As String
    Dim fileName As String
    Dim wb As Workbook
    Dim processCount As Long
    
    ' 高速化設定（画面更新、自動計算、警告表示を停止）
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.DisplayAlerts = False
    
    ' マクロブックと同じフォルダのパスを取得
    folderPath = ThisWorkbook.Path & "\"
    
    ' 拡張子が xls で始まる全ファイル (*.xlsx, *.xlsm, *.xls 等) を取得
    fileName = Dir(folderPath & "*.xls*")
    
    processCount = 0
    
    ' フォルダ内のファイルを順次処理
    Do While fileName <> ""
        
        ' このマクロブック自身、および一時ファイル(~$...)は除外する
        If fileName <> ThisWorkbook.Name And Left(fileName, 2) <> "~$" Then
            
            ' エラーハンドリング（ファイル破損等で止まらないように）
            On Error Resume Next
            Set wb = Workbooks.Open(folderPath & fileName)
            On Error GoTo 0
            
            If Not wb Is Nothing Then
                ' 各ブックに対する処理を実行（下部のSubプロシージャを呼び出し）
                Call ProcessWorkbook(wb)
                
                ' 保存して閉じる
                wb.Close SaveChanges:=True
                
                processCount = processCount + 1
                Set wb = Nothing
            End If
        End If
        
        ' 次のファイルを取得
        fileName = Dir()
    Loop
    
    ' 設定を元に戻す
    Application.DisplayAlerts = True
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    
    ' 完了メッセージ
    MsgBox processCount & " 個のファイルを処理しました。", vbInformation, "完了"

End Sub

' ---------------------------------------------------------------------------------------
' Procedure : ProcessWorkbook
' Purpose   : 個別のブックに対する書式設定と計算処理（以前のメインロジック）
' ---------------------------------------------------------------------------------------
Sub ProcessWorkbook(targetWb As Workbook)
    Dim ws As Worksheet
    Dim headerRow As Long
    Dim lastRow As Long
    Dim i As Long, r As Long
    Dim matchedColumn As String ' "C" または "D"
    Dim checkVal As String
    Dim dataStartRow As Long
    Dim cellAVal As String
    Dim unitVal As String
    
    ' 1. ループ処理: 対象ブック内の全てのシートを巡回
    For Each ws In targetWb.Worksheets
        
        ' 変数の初期化
        headerRow = 0
        matchedColumn = ""
        
        ' 2. ヘッダー行の特定: 1行目から5行目を探索
        For i = 1 To 5
            ' C列に「単位」が含まれるか確認
            If InStr(ws.Cells(i, "C").Value, "単位") > 0 Then
                headerRow = i
                matchedColumn = "C"
                Exit For ' 見つかったらループを抜ける
            ' D列に「単位」が含まれるか確認
            ElseIf InStr(ws.Cells(i, "D").Value, "単位") > 0 Then
                headerRow = i
                matchedColumn = "D"
                Exit For ' 見つかったらループを抜ける
            End If
        Next i
        
        ' ヘッダーが見つかった場合のみ処理を続行
        If headerRow > 0 Then
            
            ' データの最終行を取得（A列を基準）
            lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
            dataStartRow = headerRow + 1
            
            ' データ行が存在する場合のみ実行
            If lastRow >= dataStartRow Then
                
                ' 3. 条件分岐処理
                If matchedColumn = "C" Then
                    ' 【パターンA】 C列に「単位」がある場合
                    
                    checkVal = ws.Cells(headerRow, "D").Value
                    checkVal = Replace(checkVal, " ", "")
                    checkVal = Replace(checkVal, "　", "")
                    
                    ' D列が「単価」ではない場合
                    If checkVal <> "単価" Then
                        ' E列の書式設定
                        With ws.Range(ws.Cells(dataStartRow, "E"), ws.Cells(lastRow, "E"))
                            .HorizontalAlignment = xlRight
                            .VerticalAlignment = xlBottom
                            .WrapText = False
                            .IndentLevel = 0
                        End With
                    End If
                    
                ElseIf matchedColumn = "D" Then
                    ' 【パターンB】 D列に「単位」がある場合
                    
                    checkVal = ws.Cells(headerRow, "E").Value
                    checkVal = Replace(checkVal, " ", "")
                    checkVal = Replace(checkVal, "　", "")
                    
                    If checkVal = "単価" Then
                        ' --- 条件: E列が「単価」の場合 ---
                        
                        ' 書式設定を一括適用
                        With Union(ws.Range(ws.Cells(dataStartRow, "C"), ws.Cells(lastRow, "C")), _
                                   ws.Range(ws.Cells(dataStartRow, "E"), ws.Cells(lastRow, "E")), _
                                   ws.Range(ws.Cells(dataStartRow, "F"), ws.Cells(lastRow, "F")))
                            .HorizontalAlignment = xlRight
                            .VerticalAlignment = xlBottom
                            .WrapText = False
                            .IndentLevel = 0
                        End With
                        
                        ' 行ごとの計算式設定ループ
                        For r = dataStartRow To lastRow
                            cellAVal = ws.Cells(r, "A").Value      ' A列の値
                            unitVal = ws.Cells(r, "D").Value       ' 単位列(D列)の値
                            
                            ' 優先順位1: A列に「計」が含まれている場合
                            If InStr(cellAVal, "計") > 0 Then
                                ' データ開始行から直前行までの合計をF列に出す
                                If r > dataStartRow Then
                                    ws.Cells(r, "F").Formula = "=SUM(F" & dataStartRow & ":F" & (r - 1) & ")"
                                End If
                                
                            ' 優先順位2: 単位列(D列)に値がある場合のみ計算
                            ElseIf Trim(unitVal) <> "" Then
                                ' 通常の掛け算: =C行 * E行
                                ws.Cells(r, "F").Formula = "=C" & r & "*E" & r
                                
                            ' それ以外（単位が空で、計でもない）は計算式を記述しない
                            End If
                        Next r
                        
                    Else
                        ' --- 条件: E列が「単価」ではない場合 ---
                        
                        ' E列の書式設定のみ
                        With ws.Range(ws.Cells(dataStartRow, "E"), ws.Cells(lastRow, "E"))
                            .HorizontalAlignment = xlRight
                            .VerticalAlignment = xlBottom
                            .WrapText = False
                            .IndentLevel = 0
                        End With
                    End If
                End If
            End If
        End If
    Next ws
End Sub
